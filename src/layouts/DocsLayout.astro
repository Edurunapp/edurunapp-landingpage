---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';
import '../styles/global.css';

// 1. Definimos los tipos para que TypeScript entienda la estructura
interface Props {
  title: string;
  headings?: MarkdownHeading[];
}

type GroupedDocs = Record<string, {
  type: 'file' | 'folder';
  item?: CollectionEntry<'docs'>; // Solo si es file
  items?: CollectionEntry<'docs'>[]; // Solo si es folder
}>;

const { title, headings } = Astro.props;

// 2. Lógica para el Menú Lateral (Tipada correctamente)
const allDocs = await getCollection('docs');

const groupedDocs = allDocs.reduce<GroupedDocs>((acc, doc) => {
  const parts = doc.slug.split('/');
  if (parts.length > 1) {
    // Es un archivo dentro de una carpeta
    const folderName = parts[0];
    if (!acc[folderName]) {
      acc[folderName] = { type: 'folder', items: [] };
    }
    acc[folderName].items?.push(doc);
  } else {
    // Es un archivo raíz
    acc[doc.slug] = { type: 'file', item: doc };
  }
  return acc;
}, {});

// Orden manual de las secciones
const sortOrder = ['guia-docente', 'instalacion', 'arquitectura', 'riesgos'];
---

<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/webp" href="/logo.webp" />
    <title>{title} | Documentación Edurun</title>
  </head>
  <body class="bg-white text-edurun-dark flex min-h-screen">
    
    <aside class="w-64 bg-gray-50 border-r border-gray-200 fixed h-full hidden md:block overflow-y-auto z-20">
      <div class="p-6">
        <a href="/" class="flex items-center gap-2 mb-8 group">
            <img src="/logo.png" class="w-8 h-8 group-hover:scale-110 transition-transform" alt="Logo">
            <span class="font-bold text-lg text-gray-800">Edurun Docs</span>
        </a>
        
        <nav class="space-y-2">
          {sortOrder.map((key) => {
            const entry = groupedDocs[key];
            if (!entry) return null;

            if (entry.type === 'file' && entry.item) {
              // ENLACE SIMPLE
              const doc = entry.item;
              const isActive = Astro.url.pathname.includes(doc.slug);
              return (
                <a 
                  href={`/docs/${doc.slug}`}
                  class:list={[
                    "block px-3 py-2 rounded-md text-sm font-medium transition-all",
                    isActive 
                      ? "bg-blue-50 text-edurun-blue border-l-4 border-edurun-blue font-bold shadow-sm" 
                      : "text-gray-600 hover:bg-white hover:text-gray-900 hover:shadow-sm"
                  ]}
                >
                  {doc.data.title}
                </a>
              );
            } else if (entry.type === 'folder' && entry.items) {
              // CARPETA DESPLEGABLE
              const isOpen = entry.items.some(d => Astro.url.pathname.includes(d.slug));
              return (
                <details class="group/folder" open={isOpen}>
                  <summary class="flex items-center justify-between px-3 py-2 text-sm font-bold text-gray-700 cursor-pointer hover:bg-white hover:shadow-sm rounded-md transition-all select-none">
                    <span class="capitalize flex items-center gap-2">
                      <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                      {key.replace('-', ' ')}
                    </span>
                    <svg class="w-4 h-4 transition-transform group-open/folder:rotate-180 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </summary>
                  
                  <div class="mt-1 ml-4 border-l-2 border-gray-200 pl-2 space-y-1">
                    {entry.items.map((doc) => (
                      <a 
                        href={`/docs/${doc.slug}`}
                        class:list={[
                          "block px-3 py-1.5 rounded-md text-sm transition-colors relative",
                          Astro.url.pathname.includes(doc.slug)
                            ? "text-edurun-blue font-semibold bg-blue-50/50"
                            : "text-gray-500 hover:text-gray-900 hover:bg-gray-50"
                        ]}
                      >
                        {doc.data.title}
                      </a>
                    ))}
                  </div>
                </details>
              );
            }
          })}
        </nav>

        <div class="mt-8 pt-8 border-t border-gray-200">
            <a href="/" class="flex items-center gap-2 text-xs text-gray-500 hover:text-edurun-blue transition-colors">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
              Volver al inicio
            </a>
        </div>
      </div>
    </aside>

    <main class="flex-1 md:ml-64 xl:mr-64 min-w-0">
      <div class="max-w-4xl mx-auto p-8 md:p-12">
        
        <nav class="flex items-center text-sm text-gray-500 mb-8 space-x-2 overflow-x-auto whitespace-nowrap pb-2">
          <a href="/docs/guia-docente" class="hover:text-edurun-blue transition-colors">Docs</a>
          <span class="text-gray-300">/</span>
          {Astro.url.pathname.split('/').slice(2, -1).map((segment) => (
            <>
              <span class="capitalize text-gray-600">{segment.replace('-', ' ')}</span>
              <span class="text-gray-300">/</span>
            </>
          ))}
          <span class="text-edurun-blue font-medium truncate">{title}</span>
        </nav>

        <article class="prose prose-lg prose-slate max-w-none prose-headings:scroll-mt-20 prose-a:text-edurun-blue hover:prose-a:text-edurun-purple prose-img:rounded-xl prose-img:shadow-lg">
          <!--<h1 class="text-4xl font-extrabold text-gray-900 mb-6">{title}</h1>-->
          <slot />
        </article>

        <div class="mt-16 pt-8 border-t border-gray-100 flex justify-between text-sm text-gray-400">
          <span>Última actualización: {new Date().toLocaleDateString()}</span>
          <a href="#" class="hover:text-gray-600">Editar en GitHub</a>
        </div>
      </div>
    </main>

    <aside class="hidden xl:block w-64 fixed right-0 top-0 h-full bg-white border-l border-gray-100 z-10 overflow-y-auto">
      <div class="p-8">
        <h5 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">En esta página</h5>
        <ul class="space-y-3 text-sm border-l-2 border-gray-100">
          {headings && headings.map((h) => (
            <li class={`pl-3 -ml-[2px] ${h.depth === 3 ? 'pl-6' : ''}`}>
              <a 
                href={`#${h.slug}`} 
                class="block text-gray-500 hover:text-edurun-blue hover:border-l-2 hover:border-edurun-blue -ml-[2px] pl-3 py-0.5 transition-all truncate"
                title={h.text}
              >
                {h.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </aside>

    <script>
      document.querySelectorAll('pre').forEach((pre) => {
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        if(pre.parentNode) {
            pre.parentNode.insertBefore(wrapper, pre);
        }
        wrapper.appendChild(pre);

        const button = document.createElement('button');
        button.className = 'copy-code absolute top-3 right-3 px-2 py-1 bg-gray-700/50 hover:bg-edurun-blue text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-all border border-white/10 backdrop-blur-sm';
        button.innerText = 'Copiar';
        
        wrapper.classList.add('group');
        wrapper.appendChild(button);

        button.addEventListener('click', async () => {
          const code = pre.querySelector('code')?.innerText;
          if (code) {
            await navigator.clipboard.writeText(code);
            button.innerText = '¡Copiado!';
            button.classList.add('bg-green-500', 'text-white');
            
            setTimeout(() => {
              button.innerText = 'Copiar';
              button.classList.remove('bg-green-500', 'text-white');
            }, 2000);
          }
        });
      });
    </script>

  </body>
</html>