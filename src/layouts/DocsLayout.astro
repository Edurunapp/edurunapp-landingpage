---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';
import { ClientRouter } from 'astro:transitions'; 
import ThemeToggle from '../components/ThemeToggle.astro';
import '../styles/global.css';

interface Props {
  title: string;
  headings?: MarkdownHeading[];
}

type GroupedDocs = Record<string, {
  type: 'file' | 'folder';
  item?: CollectionEntry<'docs'>;
  items?: CollectionEntry<'docs'>[];
}>;

const { title, headings } = Astro.props;

const allDocs = await getCollection('docs');
const groupedDocs = allDocs.reduce<GroupedDocs>((acc, doc) => {
  const parts = doc.slug.split('/');
  if (parts.length > 1) {
    const folderName = parts[0];
    if (!acc[folderName]) acc[folderName] = { type: 'folder', items: [] };
    acc[folderName].items?.push(doc);
  } else {
    acc[doc.slug] = { type: 'file', item: doc };
  }
  return acc;
}, {});

const sortOrder = ['guia-docente', 'instalacion', 'arquitectura', 'riesgos'];

const flatDocs = sortOrder.flatMap(key => {
  const entry = groupedDocs[key];
  if (!entry) return [];
  if (entry.type === 'file') return [entry.item];
  if (entry.type === 'folder') return entry.items || [];
  return [];
});

const currentSlug = Astro.url.pathname.replace(/^\/docs\//, '').replace(/\/$/, '');
const currentIndex = flatDocs.findIndex(doc => doc?.slug === currentSlug);
const prevDoc = flatDocs[currentIndex - 1];
const nextDoc = flatDocs[currentIndex + 1];
---

<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/webp" href="/logo.webp" />
    <title>{title} | DocumentaciÃ³n Edurun</title>
    <ClientRouter />

    <script is:inline>
      const applyTheme = () => {
        const theme = typeof localStorage !== 'undefined' ? localStorage.getItem('theme') : 'light';
        if (theme === 'dark') document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      };
      applyTheme();
      document.addEventListener('astro:after-swap', applyTheme);
    </script>

    <style is:global>
        /* Ocultar UI de Google Translate completamente */
        .goog-te-banner-frame { display: none !important; }
        body { top: 0px !important; }
        #google_translate_element { display: none !important; }
        .skiptranslate { display: none !important; }
        button:focus { outline: none !important; }
    </style>
  </head>
  
  <body class="bg-white dark:bg-[#1e1e20] text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-300 antialiased">
    
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/95 dark:bg-[#1e1e20]/95 border-b border-gray-200 dark:border-gray-700 backdrop-blur-md h-16 transition-colors duration-300">
      <div class="h-full px-4 md:px-6 flex items-center justify-between">
        
        <div class="flex items-center gap-4">
            <button id="menu-toggle" class="md:hidden text-gray-500 hover:text-edurun-blue focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <a href="/" class="flex items-center gap-2 group">
                <img src="/logo.webp" class="w-8 h-8 group-hover:scale-110 transition-transform" alt="Logo">
                <span class="font-bold text-xl text-gray-900 dark:text-white tracking-tight">Edurun<span class="text-edurun-blue">Docs</span></span>
            </a>
        </div>

        <div class="flex items-center gap-4">
             <div class="relative group hidden sm:block">
                <button type="button" class="flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-edurun-blue transition-colors px-3 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 bg-gray-50 dark:bg-gray-800">
                    <span id="current-lang-label">EspaÃ±ol</span>
                    <svg class="w-3 h-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
                
                <div class="absolute right-0 top-full mt-2 w-40 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all transform origin-top-right z-[100] py-1 flex flex-col overflow-hidden">
                    <button type="button" onclick="changeLanguage('es')" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-edurun-blue flex items-center gap-2 cursor-pointer">
                        <span>ðŸ‡ªðŸ‡¸ EspaÃ±ol</span>
                    </button>
                    <button type="button" onclick="changeLanguage('en')" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-edurun-blue flex items-center gap-2 cursor-pointer">
                        <span>ðŸ‡ºðŸ‡¸ English</span>
                    </button>
                    <button type="button" onclick="changeLanguage('pt')" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-edurun-blue flex items-center gap-2 cursor-pointer">
                        <span>ðŸ‡§ðŸ‡· PortuguÃªs</span>
                    </button>
                </div>
            </div>
            <ThemeToggle />
        </div>
      </div>
    </header>

    <div class="flex pt-16 min-h-screen">
        <aside id="sidebar-left" class="fixed top-16 left-0 z-40 w-64 h-[calc(100vh-4rem)] transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-in-out bg-gray-50 dark:bg-[#18181a] border-r border-gray-200 dark:border-gray-700 overflow-y-auto">
            <div class="p-6">
                <nav class="space-y-2">
                    {sortOrder.map((key) => {
                        const entry = groupedDocs[key];
                        if (!entry) return null;
                        if (entry.type === 'file' && entry.item) {
                            return (
                                <a href={`/docs/${entry.item.slug}`} class={`block px-3 py-2 rounded-md text-sm font-medium transition-colors ${Astro.url.pathname.includes(entry.item.slug) ? 'bg-blue-50 dark:bg-blue-900/20 text-edurun-blue' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800'}`}>
                                    {entry.item.data.title}
                                </a>
                            );
                        } else if (entry.type === 'folder' && entry.items) {
                            return (
                                <details class="group/folder" open>
                                    <summary class="flex items-center justify-between px-3 py-2 text-sm font-bold text-gray-700 dark:text-gray-200 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md select-none transition-colors">
                                        <span class="capitalize flex items-center gap-2">
                                            <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                                            {key.replace('-', ' ')}
                                        </span>
                                        <svg class="w-4 h-4 transition-transform group-open/folder:rotate-180 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </summary>
                                    <div class="mt-1 ml-4 border-l-2 border-gray-200 dark:border-gray-700 pl-2 space-y-1">
                                        {entry.items.map(doc => (
                                            <a href={`/docs/${doc.slug}`} class={`block px-3 py-1.5 rounded-md text-sm transition-colors ${Astro.url.pathname.includes(doc.slug) ? 'text-edurun-blue font-semibold bg-blue-50/50 dark:bg-blue-900/10' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-800'}`}>
                                                {doc.data.title}
                                            </a>
                                        ))}
                                    </div>
                                </details>
                            );
                        }
                    })}
                </nav>
            </div>
        </aside>
        
        <div id="backdrop" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm top-16"></div>

        <main class="flex-1 min-w-0 md:ml-64 xl:mr-64 p-8 md:p-12 transition-all duration-300 ease-in-out">
            <div class="max-w-4xl mx-auto">
                <nav class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-8 overflow-x-auto whitespace-nowrap">
                    <span class="text-edurun-blue font-semibold">Docs</span>
                    <span class="mx-2 text-gray-300 dark:text-gray-600">/</span>
                    <span class="font-medium text-gray-900 dark:text-white truncate">{title}</span>
                </nav>

                <article class="prose prose-lg prose-slate dark:prose-invert max-w-none prose-headings:scroll-mt-24 prose-a:text-edurun-blue hover:prose-a:text-edurun-purple prose-img:rounded-xl prose-img:shadow-lg">
                    <slot />
                </article>

                <div class="mt-16 pt-8 border-t border-gray-100 dark:border-gray-800 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {prevDoc ? (
                        <a href={`/docs/${prevDoc.slug}`} class="group p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:border-edurun-blue dark:hover:border-edurun-blue hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-all">
                            <div class="text-xs text-gray-400 font-medium uppercase mb-1">Anterior</div>
                            <div class="text-edurun-blue font-semibold group-hover:underline">{prevDoc.data.title}</div>
                        </a>
                    ) : <div></div>}
                    
                    {nextDoc && (
                        <a href={`/docs/${nextDoc.slug}`} class="group p-4 border border-gray-200 dark:border-gray-700 rounded-xl text-right hover:border-edurun-blue dark:hover:border-edurun-blue hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-all">
                            <div class="text-xs text-gray-400 font-medium uppercase mb-1">Siguiente</div>
                            <div class="text-edurun-blue font-semibold group-hover:underline">{nextDoc.data.title}</div>
                        </a>
                    )}
                </div>
            </div>
        </main>

        <aside class="hidden xl:block fixed top-16 right-0 w-64 h-[calc(100vh-4rem)] bg-white dark:bg-[#1e1e20] border-l border-gray-200 dark:border-gray-700 overflow-y-auto transition-all duration-300 ease-in-out">
            <div class="p-8">
                <h5 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-4">En esta pÃ¡gina</h5>
                <ul class="space-y-3 text-sm border-l-2 border-gray-100 dark:border-gray-800">
                    {headings?.map((h) => (
                        <li class={`pl-3 -ml-[2px] ${h.depth === 3 ? 'pl-6' : ''}`}>
                            <a href={`#${h.slug}`} class="block text-gray-500 dark:text-gray-400 hover:text-edurun-blue dark:hover:text-edurun-blue hover:border-l-2 hover:border-edurun-blue -ml-[2px] pl-3 py-0.5 transition-all truncate">
                                {h.text}
                            </a>
                        </li>
                    ))}
                </ul>
            </div>
        </aside>
    </div>

    <div id="google_translate_element"></div>

    <script is:inline>
        window['googleTranslateElementInit'] = function() {
            new google.translate.TranslateElement({ pageLanguage: 'es', includedLanguages: 'en,pt,es', autoDisplay: false }, 'google_translate_element');
        }

        // --- FUNCIÃ“N NUCLEAR: SET COOKIE & RELOAD ---
        window['changeLanguage'] = function(lang) {
            console.log("Forzando cambio de idioma a:", lang);
            
            const domain = window.location.hostname;
            
            // 1. Limpiar cookies antiguas (para evitar conflictos)
            document.cookie = `googtrans=; path=/; domain=${domain}; expires=Thu, 01 Jan 1970 00:00:00 UTC`;
            document.cookie = `googtrans=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC`;

            if (lang !== 'es') {
                // 2. Si no es el idioma original, establecer la cookie mÃ¡gica
                // Google usa: /idioma_origen/idioma_destino
                document.cookie = `googtrans=/es/${lang}; path=/; domain=${domain}`;
                document.cookie = `googtrans=/es/${lang}; path=/;`; // Doble seguridad
            }

            // 3. Recargar la pÃ¡gina para que Google detecte la cookie y traduzca
            location.reload();
        };

        function setupUI() {
            // Actualizar etiqueta al cargar leyendo la cookie
            const match = document.cookie.match(/googtrans=\/es\/(\w+)/);
            if (match && match[1]) {
                const lang = match[1];
                const labels = { 'es': 'EspaÃ±ol', 'en': 'English', 'pt': 'PortuguÃªs' };
                const label = document.getElementById('current-lang-label');
                if(label && labels[lang]) label.innerText = labels[lang];
            }

            const btn = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar-left');
            const backdrop = document.getElementById('backdrop');
            const toggle = () => {
                if(sidebar && backdrop) {
                    const isClosed = sidebar.classList.contains('-translate-x-full');
                    if (isClosed) {
                        sidebar.classList.remove('-translate-x-full');
                        backdrop.classList.remove('hidden');
                    } else {
                        sidebar.classList.add('-translate-x-full');
                        backdrop.classList.add('hidden');
                    }
                }
            };
            if(btn) btn.addEventListener('click', toggle);
            if(backdrop) backdrop.addEventListener('click', toggle);

            document.querySelectorAll('pre').forEach((pre) => {
              if (pre.parentNode && pre.parentNode.querySelector('.copy-code')) return;
              const wrapper = document.createElement('div');
              wrapper.style.position = 'relative';
              if(pre.parentNode) pre.parentNode.insertBefore(wrapper, pre);
              wrapper.appendChild(pre);
              const button = document.createElement('button');
              button.className = 'copy-code absolute top-3 right-3 px-2 py-1 bg-gray-700/50 hover:bg-edurun-blue text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-all border border-white/10 backdrop-blur-sm';
              button.innerText = 'Copiar';
              wrapper.classList.add('group');
              wrapper.appendChild(button);
              button.addEventListener('click', async () => {
                const code = pre.querySelector('code')?.innerText;
                if (code) {
                    await navigator.clipboard.writeText(code);
                    button.innerText = 'Â¡Copiado!';
                    button.classList.add('bg-green-500');
                    setTimeout(() => { button.innerText = 'Copiar'; button.classList.remove('bg-green-500'); }, 2000);
                }
              });
            });
        }
        setupUI();
        document.addEventListener('astro:page-load', setupUI);
    </script>
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  </body>
</html>